# プロダクトについて

## ネガティブSNS「Grumble（グランブル）」

- **アイデア:** ポジティブな投稿や「映え」は一切禁止。日々の愚痴や不満、ちょっとしたイライラだけを投稿できるSNS。「いいね！」の代わりに「わかる…」ボタンがあり、共感を集めるほど投稿が成仏（タイムラインから消える）していきます。
- **面白ポイント:** 人はポジティブなことばかりではない、という事実に着目。普段は言えない本音を吐き出す背徳感と、共感される安心感が癖になります。投稿は24時間で消える仕様で、気軽に愚痴れます。

# 差別化案

## ネガティブSNS「Grumble」：JodelやWhisperとの差別化アイデア

ご提示いただいたネガティブSNS「Grumble（グランブル）」のアイデアは、非常にユニークで現代人のニーズを捉えています。この魅力的なコンセプトを、既存の匿名SNSである「Jodel」や「Whisper」と明確に差別化し、唯一無二の存在にするためのアイデアを以下に提案します。

---

### 1. 「成仏」システムの進化とゲーム性の導入

「わかる…」が集まると投稿が消える「成仏」は、Grumbleの核となる優れたアイデアです。これをさらに強化し、他のSNSにはない体験を生み出します。

| アイデア | 詳細 | 差別化ポイント |
|---|---|---|
| **お焚き上げイベント** | 週に一度、特定のテーマ（例：「#今週の理不尽上司」「#満員電車の悲劇」）で愚痴を募集。深夜0時など、特定の時間に集まった愚痴が一斉に燃え上がるようなアニメーションと共に「お焚き上げ」され、参加者全員がスッキリ感を共有できるイベントを開催します。 | JodelやWhisperにはない、**一体感とカタルシス**を定期的なイベントとして提供し、ユーザーの継続利用を促進します。 |
| **徳ポイントと「菩薩」ランキング** | 「わかる…」を押す行為を「徳を積む」と定義。他人の愚痴に共感する（徳を積む）ことでポイントが貯まり、週間・月間で「最も徳を積んだユーザー＝菩薩ランキング」として表彰します。プロフィールに「今週の菩薩」のような称号が表示されます。 | Jodelのカルマ（投稿評価）とは異なり、**他者への共感（聞く姿勢）を評価する**独自のシステム。これにより、健全なコミュニティの循環が生まれます。 |
| **成仏演出のカスタマイズ** | 「わかる…」が貯まって成仏する際のアニメーションを複数用意。「煙のように消える」「光に包まれて昇天する」「木魚の音と共に消える」など、ユーザーが気分によって選べるようにします。 | 単なる機能ではなく、**ユーザー体験の質（UX）**を高める遊び心。Whisperの画一的な表示とは対照的です。 |

---

### 2. 「愚痴の質」を管理し、安全な空間を徹底

Grumbleの価値は、ユーザーが安心して本音を吐き出せる「心理的安全性」にあります。これをシステムレベルで担保します。

| アイデア | 詳細 | 差別化ポイント |
|---|---|---|
| **返信機能の完全廃止と「共感スタンプ」** | 愚痴に対する批判や説教、不要なアドバイスを防ぐため、自由なテキスト返信機能を完全に廃止します。その代わり、「わかる…」ボタンに加えて、「お疲れ様」「心中お察しします」「それはひどい」といった**定型文の共感スタンプ**のみを送れるようにします。 | JodelやWhisperでしばしば問題となる、**コメント欄でのレスバトルや誹謗中傷を根本から排除**。純粋な「共感」だけが存在する、世界で最も安全な愚痴のはきだし口を目指します。 |
| **「毒レベル」申告制** | 投稿者が、自分の愚痴のネガティブ度合いを「Lv.1: ちょっと一言」から「Lv.5: 今日のハイライト」のように自己申告。ユーザーはタイムラインに表示する「毒レベル」をフィルタリングできます。「今日は軽い愚痴だけ見たい」という気分に対応します。 | Whisperの深刻な告白と、Grumbleの日常的な不満との棲み分けを明確にします。ユーザーが**自分の精神状態に合わせて情報量をコントロール**できる点が新しいです。 |
| **AIによるトレンド愚痴レポート** | 投稿された膨大な愚痴をAIが解析し、「今、世の中の人が何にイライラしているか」を可視化。「今週のトレンド愚痴：#コンビニのセルフレジ」のように、個人を特定しない形で社会の不満をレポートとして配信。 | 単なるSNSに留まらず、**社会の隠れたストレスを映し出すメディア**としての側面を持ちます。Jodelのローカルな話題とは異なる、マクロな視点を提供します。 |

---

### 3. Jodel/Whisperとの根本的な思想の違い

Grumbleは、他の匿名SNSとは目的と世界観が本質的に異なります。

- **Jodelとの違い：『地域性』からの解放**
  - Jodelが「近所の人々」とのポジティブ・ネガティブ両方を含むコミュニケーションを目指すのに対し、Grumbleは**地域や属性を問わず、「ただ、今の不満に共感してほしい」という普遍的な欲求**に応えます。繋がりを求めない、一期一会の関係性が基本です。

- **Whisperとの違い：『非日常な告白』ではなく『日常のガス抜き』**
  - Whisperが画像を使って「秘密の告白」というドラマ性を帯びやすいのに対し、Grumbleはあえてテキストのみ、または地味な背景に限定することで、**「映え」や「創作」を排除**。日常の些細なイライラを、そのまま吐き出すことに特化します。目的はアドバイスや議論ではなく、**共感による浄化（デトックス）**です。

これらの差別化要素を盛り込むことで、「Grumble」は単なるネガティブSNSではなく、**「現代人の心のデトックスを担う、ゲーム感覚の浄化ツール」**という独自のポジションを確立できるでしょう。

# 将来的にやりたいこと

## 「これって私だけ？」投票機能

愚痴に、二択または三択の簡易的な投票を付けられる機能です。これにより、投稿者はよりダイレクトに共感を求めることができます。

- **どのような機能か:**
  - 愚痴を投稿する際、「投票を追加」ボタンを押すと、簡単な質問と選択肢を設定できる。
  - 例：「コンビニの『少々お待ちください』、長すぎない？」
    - 選択肢A: 「わかる、体感3分」
    - 選択肢B: 「気にしたことない」
  - 他のユーザーは、この投票に匿名で参加できる。投稿者と閲覧者は、リアルタイムで更新される投票結果のパーセンテージを見ることができます。

- **なぜ有効か・差別化ポイント:**
  - **ゲーム感覚の共感:** 投稿者は自分の感覚が多数派なのか少数派なのかをゲーム感覚で知ることができます。
  - **気軽な参加:** 閲覧者側も、「わかる…」ボタンを押すよりもさらに気軽に、「投票」という形で意思表示ができます。
  - **データとしての面白さ:** 「世の中の78%が、〇〇にイライラしている」というような、客観的なデータが見えること自体がコンテンツとして面白く、ユーザーの興味を引きます。

## 大怨霊（だいおんりょう）討伐イベント

世の中には、多くの人が共通して抱く巨大なストレス源が存在します。それを「大怨霊」として擬人化し、全ユーザーで討伐する期間限定イベントです。

- **どのような機能か:**
  - **「大怨霊」の出現:** 週の初めなどに、テーマを持った「大怨霊」が出現します。
    - 例：「月曜日の大怨霊」「満員電車の大怨霊」「理不尽上司の大怨霊」「確定申告の大怨霊」など。
  - **攻撃方法:** ユーザーは、そのテーマに沿った愚痴を投稿することが「攻撃」になります。投稿された愚痴に「わかる…」が集まることでも、追加ダメージが入ります。
  - **HPゲージの共有:** イベントページには大怨霊の巨大なHPゲージが表示されており、全ユーザーの「攻撃」によってリアルタイムで減少していきます。自分の一つの愚痴が、確かにHPを削っているのが可視化されます。
  - **討伐成功:** 期間内にHPをゼロにできれば「討伐成功」。参加者全員で、大怨霊が光に包まれて成仏する特別なアニメーションを共有し、達成感を分かち合います。

- **協力プレイ要素:**
  - **共闘感:** 全員が同じ「敵」（ストレス源）に対して、それぞれの愚痴という名の剣を振るっている感覚を共有できます。
  - **貢献の可視化:** 自分の投稿が、全体の目標達成に直接貢献していることがHPゲージで明確にわかります。
  - **一体感:** 「みんなも月曜日が嫌なんだ」「この理不尽さに苦しんでいるのは自分だけじゃないんだ」という感覚が、共通の敵を倒すという目的を通じて、強烈な一体感に変わります。


```
grumble-backend/
├─ cmd/
│  ├─ api/
│  │  ├─ main.go                 # HTTPサーバ起動（DI・ルーティング・ミドルウェア）
│  │  └─ wire.go                 # Google Wire等のDI初期化(任意)
│  ├─ batch/
│  │  └─ main.go                 # cronやジョブワーカー起動
│  └─ migrate/
│     └─ main.go                 # DBマイグレーションCLI
│
├─ api/
│  ├─ openapi/
│  │  ├─ grumble.yml             # OpenAPI定義（単一真実源）
│  │  └─ README.md
│  └─ gen/
│     ├─ http/
│     │  └─ gin/                 # oapi-codegenで生成（Gin版）
│     │     └─ openapi.gen.go
│     └─ client/
│        └─ openapi_client.gen.go# 必要ならクライアント生成
│
├─ internal/                     # シンプルなオニオンアーキテクチャ
│  ├─ controller/                # コントローラー層（HTTPハンドラー）
│  │  ├─ *_controller.go        # 各エンドポイントのコントローラー
│  │  ├─ *_presenter.go         # レスポンスの整形
│  │  ├─ dto/                    # リクエスト/レスポンスDTO
│  │  ├─ middleware/             # 認証、ロギング、リカバリー等
│  │  ├─ router/                 # ルーティング設定（Gin）
│  │  └─ httpx/                  # HTTPユーティリティ
│  │
│  ├─ usecase/                   # ユースケース層（ビジネスフロー）
│  │  ├─ grumble_post.go         # BE-01 投稿
│  │  ├─ vibe_add.go             # BE-02 共感
│  │  ├─ timeline_get.go         # BE-03 タイムライン
│  │  ├─ purify_check.go         # BE-04 成仏ロジック
│  │  ├─ purge_expired.go        # BE-05 24h削除
│  │  ├─ event_manage.go         # BE-06 イベント管理
│  │  └─ auth_anonymous.go       # BE-07 匿名認証
│  │
│  ├─ domain/                    # ドメイン層（コアビジネスロジック）
│  │  ├─ grumble/                # 愚痴ドメイン
│  │  │  ├─ grumble.go           # エンティティ
│  │  │  └─ repository.go        # リポジトリIF
│  │  ├─ vibe/                   # 共感ドメイン
│  │  │  ├─ vibe.go
│  │  │  └─ repository.go
│  │  ├─ user/                   # ユーザードメイン
│  │  │  ├─ user.go
│  │  │  └─ repository.go
│  │  ├─ event/                  # イベントドメイン
│  │  │  ├─ event.go
│  │  │  └─ repository.go
│  │  ├─ poll/                   # 投票ドメイン（将来機能）
│  │  │  ├─ poll.go
│  │  │  └─ repository.go
│  │  └─ shared/                 # ドメイン共通
│  │     ├─ error.go             # ドメインエラー
│  │     ├─ value.go             # 値オブジェクト（ID、ToxicLevel等）
│  │     └─ service/             # ドメインサービス
│  │        ├─ purify_service.go # 成仏判定
│  │        └─ virtue_service.go # 徳ポイント
│  │
│  ├─ infrastructure/            # インフラ層（フラット構造）
│  │  ├─ grumble_repository.go  # 愚痴リポジトリ実装
│  │  ├─ vibe_repository.go     # 共感リポジトリ実装
│  │  ├─ user_repository.go     # ユーザーリポジトリ実装
│  │  ├─ event_repository.go    # イベントリポジトリ実装
│  │  ├─ poll_repository.go     # 投票リポジトリ実装（将来）
│  │  ├─ cron.go                # cronジョブ管理
│  │  ├─ job_purify_check.go    # 成仏チェックジョブ
│  │  ├─ job_purge_expired.go   # 期限切れ削除ジョブ
│  │  └─ logger.go              # ロガー実装
│  │
│  └─ config/
│     └─ config.go               # 設定管理（環境変数等）
│
├─ migrations/
│  ├─ 0001_init.sql              # AnonymousUser/Grumble/Vibe/Event…
│  └─ 0002_indexes.sql
│
├─ docker/
│  ├─ Dockerfile
│  └─ docker-compose.yml         # Postgres開発環境
│
├─ Makefile
├─ go.mod
├─ go.sum
└─ README.md
```

# 技育ハッカソンDB設計 - Grumble (PostgreSQL)

## 概要
愚痴投稿アプリ「Grumble」のデータベース設計。24時間で消える投稿機能、共感システム、匿名ユーザー管理、イベント機能を含む。

## テーブル設計

### 1. 投稿テーブル (Grumble)
- grumble_id: UUID/SERIAL (PK) - 投稿の一意識別子
- user_id: UUID (FK→AnonymousUser) - 投稿者の匿名ID
- content: TEXT (NOT NULL, 280文字制限) - 愚痴の本文
- toxic_level: INT (NOT NULL, 1-5) - 投稿者の自己申告毒レベル
- vibe_count: INT (NOT NULL, DEFAULT 0) - 「わかる…」の総数（キャッシュ）
- is_purified: BOOLEAN (NOT NULL, DEFAULT FALSE) - 成仏フラグ（Trueでタイムラインから消える）
- posted_at: TIMESTAMP WITH TIME ZONE (NOT NULL) - 投稿時刻（24時間削除の基準）
- expires_at: TIMESTAMP WITH TIME ZONE (NOT NULL) - 投稿後24時間後の時刻
- is_event_grumble: BOOLEAN (NOT NULL, DEFAULT FALSE) - イベント投稿フラグ

**インデックス**: posted_at, expires_at, is_purified

### 2. 共感テーブル (Vibe)
- vibe_id: SERIAL (PK) - 共感履歴の一意識別子
- grumble_id: UUID (FK→Grumble) - 共感対象の投稿ID
- user_id: UUID (FK→AnonymousUser) - 共感した匿名ユーザーID
- vibe_type: VARCHAR(20) (NOT NULL) - 共感の種類（'WAKARU'またはスタンプ名）
- voted_at: TIMESTAMP WITH TIME ZONE (NOT NULL) - 共感した時刻

**インデックス**: grumble_id, (grumble_id, user_id) UNIQUE制約

### 3. 匿名ユーザーテーブル (AnonymousUser)
- user_id: UUID (PK) - 匿名ユーザーの一意識別子（デバイスIDから生成）
- virtue_points: INT (NOT NULL, DEFAULT 0) - 徳ポイント（共感行為で増加）
- created_at: TIMESTAMP WITH TIME ZONE (NOT NULL) - ユーザー作成日時
- profile_title: VARCHAR(50) (NULL) - 称号（例：「今週の菩薩」）

**インデックス**: virtue_points

### 4. 投票テーブル (Poll) - 将来機能
- poll_id: SERIAL (PK) - 投票の一意識別子
- grumble_id: UUID (FK→Grumble) - 投票が紐づく愚痴投稿ID
- question: VARCHAR(255) (NOT NULL) - 投票の質問文
- option_1: VARCHAR(100) (NOT NULL) - 選択肢Aのテキスト
- option_2: VARCHAR(100) (NOT NULL) - 選択肢Bのテキスト

### 5. 投票結果テーブル (PollVote) - 将来機能
- poll_vote_id: SERIAL (PK) - 投票結果の一意識別子
- poll_id: INT (FK→Poll) - 対象の投票ID
- user_id: UUID (FK→AnonymousUser) - 投票した匿名ユーザーID
- selected_option: INT (NOT NULL, 1または2) - 選択した選択肢のインデックス

**インデックス**: (poll_id, user_id) UNIQUE制約

### 6. イベントテーブル (Event)
- event_id: SERIAL (PK) - イベントの一意識別子
- event_name: VARCHAR(100) (NOT NULL) - イベント名（例：「月曜日の大怨霊」）
- event_type: VARCHAR(50) (NOT NULL) - イベント種類（'DAIONRYO'または'OTAKINAGE'）
- start_time: TIMESTAMP WITH TIME ZONE (NOT NULL) - イベント開始時刻
- end_time: TIMESTAMP WITH TIME ZONE (NOT NULL) - イベント終了時刻
- current_hp: INT (NOT NULL) - イベント進行度（HPゲージ、大怨霊のみ）
- max_hp: INT (NOT NULL) - 大怨霊の初期HP
- is_active: BOOLEAN (NOT NULL, DEFAULT FALSE) - 開催中フラグ

## 主要機能
- 24時間自動削除システム
- 匿名ユーザー管理
- 共感（「わかる…」）システム
- 菩薩ランキング（徳ポイント制）
- イベント機能（大怨霊討伐、お焚き上げ）
- 投票機能（将来実装予定）


• DB 接続に必要な情報

  - ホスト: localhost（docker compose をローカルで起動した場合）
  - ポート: 5432
  - ユーザー: grumble
  - パスワード: grumble
  - データベース名: grumble
  - 接続文字列例: postgres://grumble:grumble@localhost:5432/grumble?sslmode=disable（DATABASE_URL と同じ）

---

# 開発環境セットアップ

## Quick Start

### 最短ルート（Makeコマンド）

```bash
# 事前準備（必須）
cp .env.example .env   # 各値を環境に合わせて編集する
# Firebase Admin SDK のサービスアカウントを配置
# cp /path/to/service-account.json firebase_secrets.json

# セットアップと起動
make local-setup       # 依存関係の準備 + DB 起動 + マイグレーション
make local-api         # API サーバーをローカルで起動
```

- `make local-setup`: `make init` → `make generate` → `make local-db-up` → `make local-migrate` を順に実行し、初期セットアップを一括で済ませます。
- `make local-api`: `.env`（存在すれば）と `firebase_secrets.json` を読み込みつつ、`DATABASE_URL` や `GRUMBLE_HTTP_ADDR` のデフォルト値を補完して API サーバーを起動します。
- `make local-down`: Docker のローカルサービスをまとめて停止します。作業を終える際に実行してください。
- `make local-db-up` / `make local-db-down`: データベースだけを個別に起動・停止したい場合に利用します。
- `make local-migrate`: `.sql` マイグレーションを手動で適用したいときに再実行できます。

`.env` の作成と編集は必須です。Firebase Admin SDK のサービスアカウント（`firebase_secrets.json` など）をリポジトリ直下に配置するか、`.env` で `FIREBASE_CREDENTIALS_FILE` を指定してください。

### 詳細手順（手動で実行する場合）

```bash
# 0. 環境変数設定（必須）
cp .env.example .env
# Firebase サービスアカウントを配置
# cp /path/to/service-account.json firebase_secrets.json
# 必要に応じて .env を編集し、実環境の値を設定してください
# zsh/bash の場合は以下で読み込みできます
set -a; source .env; set +a

# 1. 依存関係のインストール
make init

# 2. OpenAPI仕様から Go コード生成
# フロントエンドリポジトリ（github.com/dokkiitech/Grumble）から自動取得
make generate

# 3. データベース起動
docker compose -f docker/docker-compose.yml up -d

# 4. DBマイグレーション実行
go run ./cmd/migrate

# 5. API サーバー起動
go run ./cmd/api
```

## API 認証

- すべての保護されたエンドポイント（例: `/grumbles/{grumble_id}/vibes`, `/users/me`）は Firebase Authentication の ID トークンで認証します。
- リクエストヘッダーに `Authorization: Bearer <Firebase ID Token>` を付与してください。
- バックエンドでは Firebase Admin SDK を利用してトークンを検証し、`uid` から内部ユーザーIDを紐付けます。無効・期限切れのトークンは `401 UNAUTHORIZED` を返します。
- `.env` で設定できる主な値:
  - `DATABASE_URL`: PostgreSQL 接続先
  - `GRUMBLE_HTTP_ADDR`: HTTP リッスンアドレス
  - `FIREBASE_PROJECT_ID`: Firebase プロジェクトID（サービスアカウントがあれば自動検出）
  - `FIREBASE_CREDENTIALS_FILE`: サービスアカウントJSONのパス（ADC利用時は空欄でも可）
  - `GIN_MODE`: `release` / `debug` など Gin の動作モード（未設定時は `release`）
  - `CORS_ALLOWED_ORIGINS`: カンマ区切りで許可するオリジン（未設定時は `http://localhost:3000`,`http://localhost:8081`,`http://localhost:19006`）
- ルート直下に `firebase_secrets.json` を配置すると自動検出されます（`.env` や `make local-api` で指定がない場合のデフォルト）。
- Firebase Admin SDK を利用するため、ローカル開発ではサービスアカウントJSONをダウンロードし、`FIREBASE_CREDENTIALS_FILE` または `GOOGLE_APPLICATION_CREDENTIALS` でパスを指定してください。

## マイグレーションの運用

- `go run ./cmd/migrate` は `migrations/*.sql` を適用し、`schema_migrations` テーブルで実行済みバージョンを管理します。
- API を起動する前に一度実行してください（デプロイや CI/CD でも同様）。
- SQL ファイルを追加したら、各環境でこの CLI を再実行するだけで差分が適用されます。

## OpenAPI 仕様について

**重要**: このバックエンドは独自の OpenAPI 仕様を持ちません。フロントエンドリポジトリの `openapi.yaml` を参照します。

- **リポジトリ**: `git@github.com:dokkiitech/Grumble.git`
- **ファイル**: `openapi.yaml`（ルートディレクトリ）
- **コード生成**: `make generate` で自動的に読み込み

詳細は `oapi-codegen/README.md` を参照してください。

## ディレクトリ構造

シンプルなオニオンアーキテクチャ（5層構成）：

```
internal/
├── controller/      # HTTPハンドラー（Gin）
├── usecase/         # ビジネスロジック
├── domain/          # ドメインモデル（各ドメインごとにディレクトリ分割）
├── infrastructure/  # DB、キャッシュ、ジョブ等
└── config/          # 設定管理
```

詳細は `CLAUDE.md` を参照してください。
